<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chapter & Verse | Inventory Dashboard</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Roboto:wght@400;500&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Roboto", sans-serif;
        background: linear-gradient(120deg, #f7e9dc 0%, #f7f4ef 100%);
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        margin: 0;
      }
      .main-content {
        flex: 1 0 auto;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        padding-top: 2em;
        position: relative;
      }
      .dashboard-topbar {
        position: absolute;
        top: 2em;
        right: 3vw;
        display: flex;
        align-items: center;
        gap: 0.5em;
        z-index: 2;
        background: none;
        padding: 0;
        border-radius: 0;
        box-shadow: none;
      }
      .dropdown {
        position: relative;
        display: inline-block;
      }
      .dashboard-username {
        color: #4a4e69;
        font-weight: 600;
        font-size: 1em;
        letter-spacing: 0.5px;
        background: #f7e9dc;
        padding: 0.4em 1.1em;
        border-radius: 999px;
        box-shadow: 0 1px 4px rgba(74, 78, 105, 0.08);
        margin-right: 0.3em;
        border: 1px solid #e0a96d;
        cursor: pointer;
        transition: background 0.2s;
        user-select: none;
      }
      .dashboard-username:hover,
      .dashboard-username.active {
        background: #ffe5c2;
      }
      .dropdown-content {
        display: none;
        position: absolute;
        right: 0;
        top: 110%;
        min-width: 180px;
        background: #fff;
        box-shadow: 0 8px 24px rgba(74, 78, 105, 0.13);
        border-radius: 10px;
        z-index: 10;
        padding: 0.5em 0;
        margin-top: 0.3em;
      }
      .dropdown.show .dropdown-content {
        display: block;
      }
      .dropdown-content a,
      .dropdown-content button {
        display: block;
        width: 100%;
        padding: 0.7em 1.2em;
        background: none;
        border: none;
        text-align: left;
        color: #4a4e69;
        font-size: 1em;
        font-family: inherit;
        cursor: pointer;
        transition: background 0.2s, color 0.2s;
        outline: none;
      }
      .dropdown-content a:hover,
      .dropdown-content button:hover {
        background: #f7e9dc;
        color: #b5835d;
      }
      .dropdown-content .dropdown-divider {
        height: 1px;
        background: #eee;
        margin: 0.2em 0;
        border: none;
      }
      .dashboard-header {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin-bottom: 1.2em;
      }
      .cafe-logo img {
        height: 48px;
        border-radius: 6px;
        box-shadow: 0 2px 8px rgba(74, 78, 105, 0.08);
      }
      .dashboard-title {
        font-family: "Playfair Display", serif;
        color: #4a4e69;
        font-size: 1.5em;
        margin: 0;
        font-weight: 700;
        letter-spacing: 0.01em;
        text-align: center;
        margin-bottom: 0.1em;
      }
      .dashboard-header::after {
        content: "";
        display: block;
        width: 80px;
        height: 3px;
        background: linear-gradient(90deg, #4a4e69 60%, #9a8c98 100%);
        border-radius: 2px;
        margin: 1.2em auto 0 auto;
        opacity: 0.18;
      }
      .inventory-table {
        width: 98vw;
        max-width: 1600px;
        border-collapse: collapse;
        background: rgba(255, 255, 255, 0.98);
        box-shadow: 0 8px 24px rgba(74, 78, 105, 0.1);
        margin-bottom: 2em;
      }
      .table-scroll {
        max-height: 500px;
        overflow-y: auto;
        width: 98vw;
        max-width: 1600px;
        margin: 0 auto;
        border-radius: 18px;
        box-shadow: 0 8px 24px rgba(74, 78, 105, 0.1);
      }
      .inventory-table th,
      .inventory-table td {
        padding: 1em;
        text-align: left;
      }
      .inventory-table th {
        background: #f7e9dc;
        color: #4a4e69;
        font-size: 1.1em;
        letter-spacing: 0.5px;
        position: sticky;
        top: 0;
        z-index: 2;
      }
      .inventory-table tr:not(:last-child) {
        border-bottom: 1px solid #eee;
      }
      .inventory-img {
        height: 60px;
        width: 60px;
        object-fit: cover;
        border-radius: 8px;
        box-shadow: 0 1px 4px rgba(74, 78, 105, 0.08);
      }
      .logout-btn {
        background: linear-gradient(90deg, #4a4e69 60%, #9a8c98 100%);
        color: white;
        padding: 0.7em 2em;
        border: none;
        border-radius: 6px;
        font-size: 1.1em;
        font-weight: 500;
        cursor: pointer;
        transition: background 0.2s, box-shadow 0.2s;
        box-shadow: 0 2px 8px rgba(74, 78, 105, 0.08);
        margin-bottom: 0;
        margin-left: 0;
      }
      .logout-btn:hover {
        background: linear-gradient(90deg, #2e3141 60%, #4a4e69 100%);
        box-shadow: 0 4px 16px rgba(74, 78, 105, 0.12);
      }
      .custom-footer {
        display: inline-block;
        margin: 3em auto 2em auto;
        padding: 0.8em 2em;
        background: rgba(255, 255, 255, 0.85);
        border-radius: 12px;
        box-shadow: 0 2px 12px rgba(74, 78, 105, 0.08);
        color: #4a4e69;
        font-size: 1.08em;
        font-weight: 500;
        letter-spacing: 0.2px;
        text-align: center;
      }
      .footer-heart {
        color: #e25555;
        font-size: 1.2em;
        vertical-align: middle;
      }
      .footer-link {
        color: #4a4e69;
        text-decoration: underline;
        font-weight: 600;
        transition: color 0.2s;
      }
      .footer-link:hover {
        color: #b5835d;
      }
      .inventory-form-container {
        width: 90vw;
        max-width: 900px;
        margin: 0 auto 2em auto;
        background: rgba(255, 255, 255, 0.98);
        border-radius: 18px;
        box-shadow: 0 4px 16px rgba(74, 78, 105, 0.08);
        padding: 1.5em 2em;
      }
      #inventory-form {
        display: flex;
        flex-wrap: wrap;
        gap: 1em;
        align-items: center;
        justify-content: space-between;
      }
      #inventory-form input {
        flex: 1 1 160px;
        min-width: 120px;
        padding: 0.6em 1em;
        border: 1px solid #c9ada7;
        border-radius: 6px;
        background: #f7f4ef;
        font-size: 1em;
      }
      #inventory-form button {
        background: linear-gradient(90deg, #4a4e69 60%, #9a8c98 100%);
        color: white;
        padding: 0.7em 2em;
        border: none;
        border-radius: 6px;
        font-size: 1.1em;
        font-weight: 500;
        cursor: pointer;
        transition: background 0.2s, box-shadow 0.2s;
        box-shadow: 0 2px 8px rgba(74, 78, 105, 0.08);
      }
      #inventory-form button:hover {
        background: linear-gradient(90deg, #2e3141 60%, #4a4e69 100%);
      }
      .add-item-btn {
        display: block;
        margin: 0 auto 2em auto;
        background: linear-gradient(90deg, #4a4e69 60%, #9a8c98 100%);
        color: white;
        padding: 0.7em 2em;
        border: none;
        border-radius: 6px;
        font-size: 1.1em;
        font-weight: 500;
        cursor: pointer;
        transition: background 0.2s, box-shadow 0.2s;
        box-shadow: 0 2px 8px rgba(74, 78, 105, 0.08);
      }
      .add-item-btn:hover {
        background: linear-gradient(90deg, #2e3141 60%, #4a4e69 100%);
      }
      .modal {
        display: none;
        position: fixed;
        z-index: 100;
        left: 0;
        top: 0;
        width: 100vw;
        height: 100vh;
        overflow: auto;
        background: rgba(0, 0, 0, 0.18);
      }
      .modal-content {
        background: #fff;
        margin: 4em auto;
        padding: 2em 2.5em 1.5em 2.5em;
        border-radius: 18px;
        box-shadow: 0 8px 32px rgba(74, 78, 105, 0.18);
        width: 100%;
        max-width: 600px;
        position: relative;
        animation: modalIn 0.2s;
        overflow-x: auto;
      }
      @keyframes modalIn {
        from {
          transform: translateY(-40px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }
      .close-modal {
        position: absolute;
        top: 1em;
        right: 1.2em;
        font-size: 2em;
        color: #b5835d;
        cursor: pointer;
        font-weight: 700;
        transition: color 0.2s;
      }
      .close-modal:hover {
        color: #4a4e69;
      }
      .modal-content h2 {
        text-align: center;
        color: #4a4e69;
        font-family: "Playfair Display", serif;
        font-size: 1.5em;
        margin-bottom: 1.2em;
      }
      .modal-form-row {
        display: flex;
        flex-wrap: wrap;
        gap: 1.2em 2em;
        margin-bottom: 0.5em;
        align-items: flex-start;
        width: 100%;
        justify-content: center;
      }
      .modal-form-row label {
        display: flex;
        flex-direction: column;
        font-size: 1em;
        color: #4a4e69;
        font-weight: 500;
        gap: 0.4em;
        align-items: flex-start;
        margin-bottom: 1em;
        min-width: 210px;
        flex: 1 1 210px;
        max-width: 260px;
      }
      .modal-form-row input {
        display: inline-block;
        width: 180px;
        height: 2.2em !important;
        min-height: 0 !important;
        max-height: 2.2em !important;
        padding: 0.35em 0.8em;
        border: 1px solid #c9ada7;
        border-radius: 6px;
        background: #f7f4ef;
        font-size: 1em;
        box-sizing: border-box;
        line-height: 1.2;
      }
      .modal-submit-btn {
        display: block;
        margin: 1.2em auto 0 auto;
        background: linear-gradient(90deg, #4a4e69 60%, #9a8c98 100%);
        color: white;
        padding: 0.7em 2em;
        border: none;
        border-radius: 6px;
        font-size: 1.1em;
        font-weight: 500;
        cursor: pointer;
        transition: background 0.2s, box-shadow 0.2s;
        box-shadow: 0 2px 8px rgba(74, 78, 105, 0.08);
      }
      .modal-submit-btn:hover {
        background: linear-gradient(90deg, #2e3141 60%, #4a4e69 100%);
      }
      .edit-btn,
      .delete-btn {
        padding: 0.32em 0.8em;
        border: none;
        border-radius: 5px;
        font-size: 0.95em;
        font-weight: 500;
        cursor: pointer;
        margin-right: 1.1em;
        transition: background 0.2s, color 0.2s, box-shadow 0.2s;
        box-shadow: 0 1px 4px rgba(74, 78, 105, 0.08);
      }
      .edit-btn {
        background: linear-gradient(90deg, #4a4e69 60%, #9a8c98 100%);
        color: #fff;
      }
      .edit-btn:hover {
        background: linear-gradient(90deg, #2e3141 60%, #4a4e69 100%);
      }
      .delete-btn {
        background: linear-gradient(90deg, #e25555 60%, #b5835d 100%);
        color: #fff;
        margin-right: 0;
      }
      .delete-btn:hover {
        background: linear-gradient(90deg, #b5835d 60%, #e25555 100%);
      }
      .operations-btns {
        display: flex;
        flex-direction: row;
        gap: 0.7em;
        align-items: center;
        justify-content: flex-start;
      }
      .dashboard-controls {
        display: flex;
        flex-direction: row;
        justify-content: flex-start;
        align-items: stretch;
        gap: 1.2em;
        margin: 0.5em auto 0.3em auto;
        width: 100%;
        max-width: 1100px;
      }
      .dashboard-controls .inventory-search-bar,
      .dashboard-controls .add-item-btn {
        height: 44px;
        box-sizing: border-box;
        font-size: 1.05em;
        border-radius: 8px;
        display: flex;
        align-items: center;
      }
      .dashboard-controls .inventory-search-bar {
        flex-grow: 0;
        min-width: 320px;
        max-width: 600px;
        width: 100%;
      }
      .dashboard-controls .add-item-btn {
        margin-left: 0;
        background: linear-gradient(90deg, #4a4e69 60%, #9a8c98 100%);
        color: #fff;
        font-weight: 600;
        border: none;
        padding: 0 1.6em;
        min-width: 110px;
        box-shadow: 0 2px 8px rgba(74, 78, 105, 0.08);
        cursor: pointer;
        transition: background 0.2s, box-shadow 0.2s;
      }
      .dashboard-controls .add-item-btn:hover {
        background: linear-gradient(90deg, #2e3141 60%, #4a4e69 100%);
        box-shadow: 0 4px 16px rgba(74, 78, 105, 0.16);
      }
      .inventory-search-bar {
        padding: 0.6em 1.2em;
        border-radius: 8px;
        border: 1.5px solid #bcbcbc;
        font-size: 1.08em;
        min-width: 240px;
        background: #f7f6f2;
        box-shadow: 0 2px 8px rgba(74, 78, 105, 0.08);
        outline: none;
        transition: border 0.2s, box-shadow 0.2s;
      }
      .inventory-search-bar:focus {
        border: 1.5px solid #4a4e69;
        box-shadow: 0 2px 12px rgba(74, 78, 105, 0.16);
        background: #fff;
      }
    </style>
  </head>
  <body>
    <div class="main-content">
      <div class="dashboard-topbar">
        <div class="dropdown">
          <span class="dashboard-username" id="dashboard-username"></span>
          <div class="dropdown-content" id="dashboard-dropdown">
            <a href="#" onclick="event.preventDefault();">Orders</a>
            <a href="#" onclick="event.preventDefault();">Profile</a>
            <a href="#" onclick="event.preventDefault();">History</a>
            <hr class="dropdown-divider" />
            <button
              onclick="localStorage.removeItem('cv_username'); window.location.href='index.html'"
            >
              Logout
            </button>
          </div>
        </div>
      </div>
      <div class="dashboard-header">
        <div class="cafe-logo">
          <img src="logo.png" alt="Chapter & Verse Logo" />
        </div>
        <h4 class="dashboard-title">Inventory Dashboard</h1>
      </div>
      <div class="dashboard-controls">
        <input
          id="inventory-search"
          type="text"
          placeholder="Search inventory..."
          class="inventory-search-bar"
        />
        <div id="add-item-btn-container"></div>
      </div>
      <div class="modal" id="add-item-modal">
        <div class="modal-content">
          <span class="close-modal" id="close-modal-btn">&times;</span>
          <h2>Add Inventory Item</h2>
          <form id="inventory-form" class="modal-form">
            <div class="modal-form-row">
              <label>SKU*
                <input type="text" name="sku" required />
              </label>
              <label>Name*
                <input type="text" name="name" required />
              </label>
            </div>
            <div class="modal-form-row">
              <label>Description
                <input type="text" name="description" />
              </label>
              <label>Image URL*
                <input type="text" name="image_url" required />
              </label>
            </div>
            <div class="modal-form-row">
              <label>RRP Price*
                <input type="number" name="price" min="0" step="0.01" required />
              </label>
              <label>Promo Name
                <input type="text" name="discount_name" />
              </label>
            </div>
            <div class="modal-form-row">
              <label>Discount Percent
                <input type="number" name="discount_percentage" min="0" max="100" step="0.01" />
              </label>
              <label>Discount Amount
                <input type="number" name="discount_amount" min="0" step="0.01" />
              </label>
            </div>
            <div class="modal-form-row">
              <label>Discount Dates (From)
                <input type="date" name="discount_from" />
              </label>
              <label>Discount Dates (To)
                <input type="date" name="discount_to" />
              </label>
            </div>
            <div class="modal-form-row">
              <label>Quantity*
                <input type="number" name="quantity" min="0" required />
              </label>
            </div>
            <button type="submit" class="modal-submit-btn">Add Item</button>
            <span
              id="inventory-form-message"
              style="margin-left: 1em; color: #b5835d"
            ></span>
          </form>
        </div>
      </div>
      <div class="table-scroll">
        <table class="inventory-table" id="inventory-table">
          <thead>
            <tr>
              <th>Image</th>
              <th>SKU</th>
              <th>Name</th>
              <th>Description</th>
              <th>Quantity Available</th>
              <th>Price</th>
              <th>Promo Name</th>
              <th>Discount Percent</th>
              <th>Discount Amount</th>
              <th>Discount Dates</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            <!-- Inventory rows will be inserted here by JS -->
          </tbody>
        </table>
      </div>
    </div>
    <footer class="custom-footer">
      Built with <span class="footer-heart">❤️</span> by
      <a
        href="https://www.linkedin.com/in/sumukhbhandarkar"
        target="_blank"
        rel="noopener"
        class="footer-link"
        >Sumukh</a
      >,
      <a
        href="https://www.linkedin.com/in/rohithrhegde/"
        target="_blank"
        rel="noopener"
        class="footer-link"
        >Rohith</a
      >
      and
      <a
        href="https://www.linkedin.com/in/akshaykinikukkundoor/"
        target="_blank"
        rel="noopener"
        class="footer-link"
        >Akshay</a
      >
      from India
    </footer>
    <script>
      // Fetch inventory from backend and render table
      async function loadInventory() {
        const res = await fetch(
          "https://chapversedublingithubio-production.up.railway.app/inventory"
        );
        const data = await res.json();
        console.log("Inventory data:", data); // <--- Add this line
        const tbody = document.querySelector("#inventory-table tbody");
        tbody.innerHTML = "";
        data.forEach((item) => {
          const priceNum = Number(item.price);
          const discountPercentageNum = Number(item.discount_percentage);
          const discountAmountNum = Number(item.discount_amount);
          const price = !isNaN(priceNum) ? "€" + priceNum.toFixed(2) : "";
          // Discount logic for display
          let discountPercentage = "";
          let discountAmount = "";
          if (!isNaN(discountAmountNum) && discountAmountNum > 0) {
            discountPercentage = "--";
            discountAmount = "€" + discountAmountNum.toFixed(2);
          } else if (
            !isNaN(discountPercentageNum) &&
            discountPercentageNum > 0
          ) {
            discountPercentage = discountPercentageNum + "%";
            discountAmount = "--";
          }
          const imageUrl =
            item.image_url && item.image_url.trim() !== ""
              ? item.image_url
              : "https://via.placeholder.com/60?text=No+Image";
          // Calculate discounted price
          let discounted = priceNum;
          if (!isNaN(discountPercentageNum) && discountPercentageNum > 0) {
            discounted = discounted * (1 - discountPercentageNum / 100);
          }
          if (!isNaN(discountAmountNum) && discountAmountNum > 0) {
            discounted = discounted - discountAmountNum;
          }
          const discountedPrice =
            !isNaN(discounted) && discounted >= 0
              ? "€" + discounted.toFixed(2)
              : "";
          const tr = document.createElement("tr");
          tr.innerHTML = `
      <td><img src="${imageUrl}" alt="${
            item.name
          }" class="inventory-img" onerror="this.onerror=null;this.src='https://via.placeholder.com/60?text=No+Image';" /></td>
      <td>${item.sku}</td>
      <td>${item.name}</td>
      <td>${item.description || ""}</td>
      <td>${item.quantity}</td>
      <td>${price}</td>
      <td>${item.discount_name || ""}</td>
      <td>${discountPercentage}</td>
      <td>${discountAmount}</td>
      <td>${formatDiscountDates(item.discount_dates)}</td>
      <td>
        <div class="operations-btns">
          ${localStorage.getItem('rights') === 'admin' ? `
            <button class="edit-btn" data-sku="${item.sku}" title="Edit">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 20 20" fill="none"><path d="M15.8 2.8a2.03 2.03 0 0 1 2.9 2.9l-1.1 1.1-2.9-2.9 1.1-1.1ZM2 15.5l9.7-9.7 2.9 2.9-9.7 9.7H2v-2.9Z" fill="#fff"/></svg>
            </button>
            <button class="delete-btn" data-sku="${item.sku}" title="Delete">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 20 20" fill="none"><path d="M7.5 2a1 1 0 0 1 1-1h3a1 1 0 0 1 1 1V3h5a1 1 0 1 1 0 2h-1v12a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5H2a1 1 0 1 1 0-2h5V2Zm7 3H5v12h10V5Zm-2 2a1 1 0 1 1 2 0v8a1 1 0 1 1-2 0V7Zm-4 0a1 1 0 1 1 2 0v8a1 1 0 1 1-2 0V7Z" fill="#fff"/></svg>
            </button>
          ` : localStorage.getItem('rights') === 'staff' ? '' : ''}
        </div>
      </td>
    `;
          tbody.appendChild(tr);
        });

        // Search/filter logic
        const searchInput = document.getElementById("inventory-search");
        if (searchInput && !searchInput.hasListener) {
          searchInput.addEventListener("input", function () {
            const filter = this.value.trim().toLowerCase();
            Array.from(tbody.querySelectorAll("tr")).forEach((row) => {
              const text = row.textContent.toLowerCase();
              row.style.display = text.includes(filter) ? "" : "none";
            });
          });
          searchInput.hasListener = true;
        }

        // Inline edit logic
        tbody.querySelectorAll(".edit-btn").forEach((btn) => {
          btn.addEventListener("click", function () {
            const sku = this.getAttribute("data-sku");
            const row = this.closest("tr");
            // Get current values from row
            const cells = row.querySelectorAll("td");
            const [
              imgCell,
              skuCell,
              nameCell,
              descCell,
              qtyCell,
              priceCell,
              promoCell,
              percentCell,
              amountCell,
              datesCell,
            ] = cells;
            // Save original row HTML in case of cancel
            const originalHTML = row.innerHTML;
            // Get current values
            const current = {
              image_url: imgCell.querySelector("img").src,
              sku: skuCell.textContent,
              name: nameCell.textContent,
              description: descCell.textContent,
              quantity: qtyCell.textContent,
              price: priceCell.textContent.replace("€", ""),
              discount_name: promoCell.textContent,
              discount_percentage:
                percentCell.textContent === "--"
                  ? ""
                  : percentCell.textContent.replace("%", ""),
              discount_amount:
                amountCell.textContent === "--"
                  ? ""
                  : amountCell.textContent.replace("€", ""),
              discount_dates: datesCell.textContent,
            };
            // Parse discount_dates for from/to
            let fromVal = "", toVal = "";
            if (current.discount_dates && current.discount_dates.includes("to")) {
              [fromVal, toVal] = current.discount_dates.split("to").map(s => s.trim());
            } else if (current.discount_dates) {
              fromVal = current.discount_dates.trim();
            }
            // Render editable row
            row.innerHTML = `
              <td><input type="text" value="${current.image_url}" style="width:60px" /></td>
              <td>${current.sku}</td>
              <td><input type="text" value="${current.name}" /></td>
              <td><input type="text" value="${current.description}" /></td>
              <td><input type="number" value="${current.quantity}" min="0" /></td>
              <td><input type="number" value="${current.price}" min="0" step="0.01" /></td>
              <td><input type="text" value="${current.discount_name}" /></td>
              <td><input type="number" value="${current.discount_percentage}" min="0" max="100" step="0.01" /></td>
              <td><input type="number" value="${current.discount_amount}" min="0" step="0.01" /></td>
              <td style="display:flex;gap:0.3em;">
                <input type="date" class="edit-discount-from" value="${fromVal}" style="width: 7.5em;" />
                <span style="align-self:center;">to</span>
                <input type="date" class="edit-discount-to" value="${toVal}" style="width: 7.5em;" />
              </td>
              <td>—</td>
              <td>
                <button class="save-btn" title="Save">💾</button>
                <button class="cancel-btn" title="Cancel">✖️</button>
              </td>
            `;
            // --- Discount date validation logic for inline edit ---
            const editFromInput = row.querySelector('.edit-discount-from');
            const editToInput = row.querySelector('.edit-discount-to');
            if (editFromInput && editToInput) {
              editFromInput.addEventListener('change', function() {
                if (this.value) {
                  editToInput.min = this.value;
                  if (editToInput.value && editToInput.value < this.value) {
                    editToInput.value = this.value;
                  }
                } else {
                  editToInput.min = '';
                }
              });
              editToInput.addEventListener('change', function() {
                if (this.value) {
                  editFromInput.max = this.value;
                  if (editFromInput.value && editFromInput.value > this.value) {
                    editFromInput.value = this.value;
                  }
                } else {
                  editFromInput.max = '';
                }
              });
            }
            // --- End discount date validation logic for inline edit ---
            // Save/cancel logic
            row.querySelector(".cancel-btn").onclick = () => {
              row.innerHTML = originalHTML;
              loadInventory();
            };
            row.querySelector(".save-btn").onclick = async () => {
              // Gather new values
              const inputs = row.querySelectorAll('input');
              const [image_url, name, description, quantity, price, discount_name, discount_percentage, discount_amount, discount_from, discount_to] = [
                inputs[0].value,
                inputs[1].value,
                inputs[2].value,
                inputs[3].value,
                inputs[4].value,
                inputs[5].value,
                inputs[6].value,
                inputs[7].value,
                inputs[8].value,
                inputs[9].value
              ];
              let discount_dates = "";
              if (discount_from && discount_to) {
                discount_dates = `${discount_from} to ${discount_to}`;
              } else if (discount_from) {
                discount_dates = discount_from;
              } else if (discount_to) {
                discount_dates = discount_to;
              } else {
                discount_dates = "";
              }
              // Validation (reuse add form logic)
              if (discount_percentage && discount_amount) {
                alert(
                  "Enter either discount percent or discount amount, not both."
                );
                return;
              }
              if (discount_amount && Number(discount_amount) >= Number(price)) {
                alert("Discount amount must be less than price.");
                return;
              }
              if (
                discount_percentage &&
                (Number(discount_percentage) < 1 ||
                  Number(discount_percentage) > 100)
              ) {
                alert("Discount percent must be between 1 and 100.");
                return;
              }
              // Send update to backend
              const payload = {
                name,
                image_url,
                description,
                quantity: Number(quantity),
                price: Number(price),
                discount_name,
                discount_percentage: discount_percentage ? Number(discount_percentage) : null,
                discount_amount: discount_amount ? Number(discount_amount) : null,
                discount_dates,
              };
              try {
                const res = await fetch(
                  `https://chapversedublingithubio-production.up.railway.app/inventory/${current.sku}`,
                  {
                    method: "PUT",
                    headers: {
                      "Content-Type": "application/json",
                      "X-Username": localStorage.getItem("cv_username") || ""
                    },
                    body: JSON.stringify(payload),
                  }
                );
                if (res.ok) {
                  loadInventory();
                } else {
                  const data = await res.json();
                  alert(data.error || "Failed to update item.");
                }
              } catch (err) {
                alert("Network error.");
              }
            };
          });
        });
        // Delete logic
        tbody.querySelectorAll(".delete-btn").forEach((btn) => {
          btn.addEventListener("click", async function () {
            const sku = this.getAttribute("data-sku");
            if (confirm("Are you sure you want to delete this item?")) {
              try {
                const res = await fetch(
                  `https://chapversedublingithubio-production.up.railway.app/inventory/${sku}`,
                  {
                    method: "DELETE",
                    headers: {
                      "X-Username": localStorage.getItem("cv_username") || ""
                    }
                  }
                );
                if (res.ok) {
                  loadInventory();
                } else {
                  const data = await res.json();
                  alert(data.error || "Failed to delete item.");
                }
              } catch (err) {
                alert("Network error.");
              }
            }
          });
        });
      }
      loadInventory();

      // Display username in camel case in the topbar
      function toCamelCase(str) {
        if (!str) return "Guest";
        return str.charAt(0).toUpperCase() + str.slice(1).toLowerCase();
      }
      const username = localStorage.getItem("cv_username");
      document.getElementById("dashboard-username").textContent =
        toCamelCase(username);

      // Dropdown logic
      const dropdown = document.querySelector(".dropdown");
      const usernameBtn = document.getElementById("dashboard-username");
      usernameBtn.addEventListener("click", function (e) {
        e.stopPropagation();
        dropdown.classList.toggle("show");
        usernameBtn.classList.toggle("active");
      });
      document.addEventListener("click", function (e) {
        dropdown.classList.remove("show");
        usernameBtn.classList.remove("active");
      });

      // Modal logic
      const closeModalBtn = document.getElementById("close-modal-btn");
      const modal = document.getElementById("add-item-modal");
      closeModalBtn.addEventListener("click", () => {
        modal.style.display = "none";
      });
      window.addEventListener("click", (e) => {
        if (e.target === modal) modal.style.display = "none";
      });

      // --- Discount date validation logic for modal ---
      const discountFromInput = document.querySelector('input[name="discount_from"]');
      const discountToInput = document.querySelector('input[name="discount_to"]');
      if (discountFromInput && discountToInput) {
        discountFromInput.addEventListener('change', function() {
          if (this.value) {
            discountToInput.min = this.value;
            if (discountToInput.value && discountToInput.value < this.value) {
              discountToInput.value = this.value;
            }
          } else {
            discountToInput.min = '';
          }
        });
        discountToInput.addEventListener('change', function() {
          if (this.value) {
            discountFromInput.max = this.value;
            if (discountFromInput.value && discountFromInput.value > this.value) {
              discountFromInput.value = this.value;
            }
          } else {
            discountFromInput.max = '';
          }
        });
      }
      // --- End discount date validation logic for modal ---

      document
        .getElementById("inventory-form")
        .addEventListener("submit", async function (e) {
          e.preventDefault();
          const form = e.target;
          const formData = Object.fromEntries(new FormData(form).entries());
          // Convert numbers
          formData.quantity = formData.quantity ? Number(formData.quantity) : 0;
          formData.price = formData.price ? Number(formData.price) : 0;
          formData.discount_percentage = formData.discount_percentage
            ? Number(formData.discount_percentage)
            : null;
          formData.discount_amount = formData.discount_amount
            ? Number(formData.discount_amount)
            : null;

          const msg = document.getElementById("inventory-form-message");
          // --- Custom validation ---
          if (formData.discount_percentage && formData.discount_amount) {
            msg.style.color = "#b5835d";
            msg.textContent =
              "Enter either discount percent or discount amount, not both.";
            return;
          }
          if (
            formData.discount_amount !== null &&
            formData.discount_amount !== "" &&
            formData.discount_amount >= formData.price
          ) {
            msg.style.color = "#b5835d";
            msg.textContent = "Discount amount must be less than price.";
            return;
          }
          if (
            formData.discount_percentage !== null &&
            (formData.discount_percentage < 1 ||
              formData.discount_percentage > 100)
          ) {
            msg.style.color = "#b5835d";
            msg.textContent = "Discount percent must be between 1 and 100.";
            return;
          }
          // --- End custom validation ---

          msg.textContent = "Adding...";
          try {
            // Build discount_dates string from from/to
            let discountFrom = formData.discount_from || "";
            let discountTo = formData.discount_to || "";
            if (discountFrom && discountTo) {
              formData.discount_dates = `${discountFrom} to ${discountTo}`;
            } else if (discountFrom) {
              formData.discount_dates = discountFrom;
            } else if (discountTo) {
              formData.discount_dates = discountTo;
            } else {
              formData.discount_dates = "";
            }
            delete formData.discount_from;
            delete formData.discount_to;

            const res = await fetch(
              "https://chapversedublingithubio-production.up.railway.app/inventory",
              {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  "X-Username": localStorage.getItem("cv_username") || ""
                },
                body: JSON.stringify(formData),
              }
            );
            const data = await res.json();
            if (res.ok) {
              msg.style.color = "#4a4e69";
              msg.textContent = "Item added!";
              form.reset();
              loadInventory();
              document.getElementById("add-item-modal").style.display = "none";
            } else {
              msg.style.color = "#b5835d";
              msg.textContent = data.error || "Failed to add item.";
            }
          } catch (err) {
            msg.style.color = "#b5835d";
            msg.textContent = "Network error.";
          }
        });

      function formatDiscountDates(datesStr) {
        if (!datesStr) return "";
        const [from, to] = datesStr.split("to").map(s => s.trim());
        const format = (d) => {
          if (!d) return "";
          const date = new Date(d);
          if (isNaN(date)) return d; // fallback to raw if invalid
          const day = date.getDate();
          const month = date.toLocaleString("default", { month: "long" });
          const year = date.getFullYear();
          return `${day} ${month} ${year}`;
        };
        if (from && to) {
          const fromDate = new Date(from);
          const toDate = new Date(to);
          if (fromDate.getFullYear() === toDate.getFullYear()) {
            return `${fromDate.getDate()} ${fromDate.toLocaleString("default", { month: "long" })} to ${toDate.getDate()} ${toDate.toLocaleString("default", { month: "long" })} ${toDate.getFullYear()}`;
          }
          return `${format(from)} to ${format(to)}`;
        }
        return format(from || to);
      }

      // Render Add Item button based on rights
      const rights = localStorage.getItem('rights');
      if (['admin', 'staff'].includes(rights)) {
        document.getElementById('add-item-btn-container').innerHTML =
          '<button class="add-item-btn" id="open-modal-btn">+ Add Item</button>';
        // Attach event listener after button is added
        document.getElementById("open-modal-btn").addEventListener("click", () => {
          document.getElementById("add-item-modal").style.display = "block";
        });
      }
    </script>
  </body>
</html>
